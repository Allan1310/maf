var clickSearchFn=function(item_obj){         //所有的查询方法
	var data={"pageNo":"1"};
	clickSearch(item_obj,data);
	
}


var clickSearch=function(item_obj,data_){
	var url=$(item_obj).closest(".panel").attr("data-url");
	var data={};
	var t=$(item_obj).closest(".panel");
	$(item_obj).closest("#form_info").find("input").each(function(index,item_o){
		switch($(item_o).attr("type")){
			case "text":
				data[$(item_o).attr("name")]=$(item_o).val();
				break;
			case "hidden":	
				data[$(item_o).attr("name")]=$(item_o).val();
				break;
		}
		
	});
	if (!$(t).hasClass("panel-loading")) {
        var n = $(t).find(".panel-body");
        var r = '<div class="panel-loader"><span class="spinner-small"></span></div>';
        $(t).addClass("panel-loading");
        $(n).prepend(r);
        setTimeout(function() {
        	var html=_loadurl(url,data_?$.extend(data,data_):data);
            $(t).removeClass("panel-loading");
            $(t).find(".panel-loader").remove();
            n.html(html);
        },
        0)
    }
};

var page=function(pageNo){
	var data={};
	$(window.event.target).closest(".panel").find("input").each(function(index,item_o){
		switch($(item_o).attr("type")){
			case "text":
				data[$(item_o).attr("name")]=$(item_o).val();
				break;
			case "hidden":	
				data[$(item_o).attr("name")]=$(item_o).val();
				break;
		}
		
	});
	data=$.extend(data,{"pageNo":pageNo});
	clickSearch(window.event.target,data);
}



var handleSlimScroll = function() {
    
    $("[data-scrollbar=true]").each(function() {
        generateSlimScroll($(this))
    })
};
var generateSlimScroll = function(e) { //滚动条美化组件
    var t = $(e).attr("data-height");
    t = !t ? $(e).height() : t;
    var n = {
        height: t,
        alwaysVisible: true
    };
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        n.wheelStep = 5;
        n.touchScrollStep = 500
    }
    $(e).slimScroll(n)
};
var handleSidebarMenu = function() { //菜单点击
    
    $(".sidebar .nav > .has-sub > a").click(function() {
        var e = $(this).next(".sub-menu");
        var t = ".sidebar .nav > li.has-sub > .sub-menu";
        if ($(".page-sidebar-minified").length === 0) {
            $(t).not(e).slideUp(250,
            function() {
                $(this).closest("li").removeClass("expand")
            });
            $(e).slideToggle(250,
            function() {
                var e = $(this).closest("li");
                if ($(e).hasClass("expand")) {
                    $(e).removeClass("expand")
                } else {
                    $(e).addClass("expand")
                }
            })
        }
    });
    $(".sidebar .nav > .has-sub .sub-menu li.has-sub > a").click(function() {
        if ($(".page-sidebar-minified").length === 0) {
            var e = $(this).next(".sub-menu");
            $(e).slideToggle(250)
        }
    })
};
var handleMobileSidebarToggle = function() {
    var e = false;
    $(".sidebar").on("click touchstart",
    function(t) {
        if ($(t.target).closest(".sidebar").length !== 0) {
            e = true
        } else {
            e = false;
            t.stopPropagation()
        }
    });
    $(document).on("click touchstart",
    function(t) {
        if ($(t.target).closest(".sidebar").length === 0) {
            e = false
        }
        if (!t.isPropagationStopped() && e !== true) {
            if ($("#page-container").hasClass("page-sidebar-toggled")) {
                e = true;
                $("#page-container").removeClass("page-sidebar-toggled")
            }
            if ($(window).width() < 979) {
                if ($("#page-container").hasClass("page-with-two-sidebar")) {
                    e = true;
                    $("#page-container").removeClass("page-right-sidebar-toggled")
                }
            }
        }
    });
    $("[data-click=right-sidebar-toggled]").click(function(t) {
        t.stopPropagation();
        var n = "#page-container";
        var r = "page-right-sidebar-collapsed";
        r = $(window).width() < 979 ? "page-right-sidebar-toggled": r;
        if ($(n).hasClass(r)) {
            $(n).removeClass(r)
        } else if (e !== true) {
            $(n).addClass(r)
        } else {
            e = false
        }
        if ($(window).width() < 480) {
            $("#page-container").removeClass("page-sidebar-toggled")
        }
    });
    $("[data-click=sidebar-toggled]").click(function(t) {
        t.stopPropagation();
        var n = "page-sidebar-toggled";
        var r = "#page-container";
        if ($(r).hasClass(n)) {
            $(r).removeClass(n)
        } else if (e !== true) {
            $(r).addClass(n)
        } else {
            e = false
        }
        if ($(window).width() < 480) {
            $("#page-container").removeClass("page-right-sidebar-toggled")
        }
    })
};
var handleSidebarMinify = function() {
    $("[data-click=sidebar-minify]").click(function(e) {
        e.preventDefault();
        var t = "page-sidebar-minified";
        var n = "#page-container";
        if ($(n).hasClass(t)) {
            $(n).removeClass(t);
            if ($(n).hasClass("page-sidebar-fixed")) {
                generateSlimScroll($('#sidebar [data-scrollbar="true"]'))
            }
        } else {
            $(n).addClass(t);
            if ($(n).hasClass("page-sidebar-fixed")) {
                $('#sidebar [data-scrollbar="true"]').slimScroll({
                    destroy: true
                });
                $('#sidebar [data-scrollbar="true"]').removeAttr("style")
            }
            $("#sidebar [data-scrollbar=true]").trigger("mouseover")
        }
        $(window).trigger("resize")
    })
};
var handlePageContentView = function() {
    $.when($("#page-loader").addClass("hide")).done(function() {
        $("#page-container").addClass("in")
    })
};
var handlePanelAction = function(e) {    //对窗口按钮的功能定义
 	$("[data-click=panel-remove]").unbind();
	$("[data-click=panel-collapse]").unbind();
	$("[data-click=panel-set]").unbind();
	$("[data-click=panel-reload]").unbind();
	$("[data-click=panel-expand]").unbind();
    $("[data-click=panel-remove]").hover(function() { //按钮覆盖提示框
        $(this).tooltip({
            title: "关闭",
            placement: "bottom",
            trigger: "hover",
            container: "body"
        });
        $(this).tooltip("show")
    });
    $("[data-click=panel-remove]").click(function(e) {
        e.preventDefault();
        $(this).tooltip("destroy");
        $(this).closest(".panel").remove();
		if($("[data-id="+$(this).closest("div.panel-inverse").attr("data-sortable-id")+"]").length>0){
			$("[data-id="+$(this).closest("div.panel-inverse").attr("data-sortable-id")+"]").click();
		}
    });
    $("[data-click=panel-collapse]").hover(function() {
        $(this).tooltip({
            title: "放大/缩小",
            placement: "bottom",
            trigger: "hover",
            container: "body"
        });
        $(this).tooltip("show")
    });
    $("[data-click=panel-collapse]").click(function(e) {
        e.preventDefault();
        $(this).closest(".panel").find(".panel-body").slideToggle()
    });
    $("[data-click=panel-set]").hover(function() {
        $(this).tooltip({
            title: "背景设置",
            placement: "bottom",
            trigger: "hover",
            container: "body"
        });
        $(this).tooltip("show");
    });
    $("[data-click=panel-set]").each(function(i,o) {
    	var $this=$(o);
    	$this.colorpicker({
            fillcolor:true,
            event:'click',
            point:"right",
            inputshow:true,
            target:$this.children("input"),
            success:function(o,color){
            	console.info("duixiang",o);
            	o.closest(".panel-heading").css("backgroundColor",color);
            	o.closest(".panel").attr("data-color",color);
            	handleSavePanelPosition();
            }
        });
    });
    $("[data-click=panel-reload]").hover(function() {
        $(this).tooltip({
            title: "刷新",
            placement: "bottom",
            trigger: "hover",
            container: "body"
        });
        $(this).tooltip("show")
    });
    $("[data-click=panel-reload]").click(function(e) {
        e.preventDefault();
        clickSearch(this);
    });
    $("[data-click=panel-expand]").hover(function() {
        $(this).tooltip({
            title: "放大/缩小",
            placement: "bottom",
            trigger: "hover",
            container: "body"
        });
        $(this).tooltip("show")
    });
    $("[data-click=panel-expand]").click(function(e) {
        e.preventDefault();
        var t = $(this).closest(".panel");
        var n = $(t).find(".panel-body");
        var r = 40;
        if ($(n).length !== 0) {
            var i = $(t).offset().top;
            var s = $(n).offset().top;
            r = s - i
        }
        if ($("body").hasClass("panel-expand") && $(t).hasClass("panel-expand")) {
            $("body, .panel").removeClass("panel-expand");
            $(".panel").removeAttr("style");
            $(n).removeAttr("style")
        } else {
            $("body").addClass("panel-expand");
            $(this).closest(".panel").addClass("panel-expand");
            if ($(n).length !== 0 && r != 40) {
                var o = 36;
                $(t).find(" > *").each(function() {
                    var e = $(this).attr("class");
                    
                    if (e.indexOf("panel-heading")<0 && e != "panel-body") {
                        o += $(this).height() + 30
                    }
                });
                if (o != 36) {
                    $(n).css("top", o + "px")
                }
            }
        }
        $(window).trigger("resize")
    })
};
var handleDraggablePanel = function() { //对panel的调用
    
    var e = $(".panel").parent("[class*=col]");
    var t = ".panel-heading";
    var n = ".row > [class*=col]";
    $(e).sortable({
        handle: t,
        connectWith: n,
        stop: function(e, t) {
            t.item.find(".panel-title").append('<i class="fa fa-refresh fa-spin m-l-5" data-id="title-spinner"></i>');
            handleSavePanelPosition(t.item)
        }
    })
};
var handelTooltipPopoverActivation = function() {
    $("[data-toggle=tooltip]").tooltip();
    $("[data-toggle=popover]").popover()
};
var handleScrollToTopButton = function() {
    $(document).scroll(function() {
        var e = $(document).scrollTop();
        if (e >= 200) {
            $("[data-click=scroll-top]").addClass("in")
        } else {
            $("[data-click=scroll-top]").removeClass("in")
        }
    });
    $("[data-click=scroll-top]").click(function(e) {
        e.preventDefault();
        $("html, body").animate({
            scrollTop: $("body").offset().top
        },
        500)
    })
};
var handleThemePageStructureControl = function() {
    if ($.cookie && $.cookie("theme")) {
        if ($(".theme-list").length !== 0) {
            $(".theme-list [data-theme]").closest("li").removeClass("active");
            $('.theme-list [data-theme="' + $.cookie("theme") + '"]').closest("li").addClass("active")
        }
		if($.cookie("theme").toUpperCase()=="BLACK"){
			$(".panel-inverse>.panel-heading").removeClass().addClass("panel-heading");
		}
		else{
			$(".panel-inverse>.panel-heading").removeClass().addClass("panel-heading panel-heading-"+$.cookie("theme").replace(/[ ]/g,""));
		}
    }
	$(".theme-list [data-theme]").live("click",
    function() {
		if($(this).attr("data-theme").toUpperCase()=="BLACK"){
			$(".panel-inverse>.panel-heading").removeClass().addClass("panel-heading");
		}
		else{
			$(".panel-inverse>.panel-heading").removeClass().addClass("panel-heading panel-heading-"+$(this).attr("data-theme").replace(/[ ]/g,""));
		}
        $(".theme-list [data-theme]").not(this).closest("li").removeClass("active");
        $(this).closest("li").addClass("active");
        $.cookie("theme", $(this).attr("data-theme").replace(/[ ]/g,""));
		handleSavePanelPosition();
    });
   
};
var handleThemePanelExpand = function() {
    $('[data-click="theme-panel-expand"]').live("click",
    function() {
        var e = ".theme-panel";
        var t = "active";
        if ($(e).hasClass(t)) {
            $(e).removeClass(t)
        } else {
            $(e).addClass(t)
        }
    })
};
var handleAfterPageLoadAddClass = function() {
    if ($("[data-pageload-addclass]").length !== 0) {
        $(window).load(function() {
            $("[data-pageload-addclass]").each(function() {
                var e = $(this).attr("data-pageload-addclass");
                $(this).addClass(e)
            })
        })
    }
};

var handleThemePanelDataFn=function(e) {
	$('[data-click="menulist"]').live("click",
    function() {
        var t = "active";
        if ($(this).hasClass(t)) {
            $(this).removeClass(t);
			$(this).closest("li").removeClass(t);
			$(this).attr("data-type","0");
			if($("[data-sortable-id="+$(this).attr("data-id")+"]").length>0){	
				 $("[data-sortable-id="+$(this).attr("data-id")+"]").find("a[data-click='panel-remove']").tooltip("destroy");
       			 $("[data-sortable-id="+$(this).attr("data-id")+"]").find("a[data-click='panel-remove']").closest(".panel").remove();
			}	
        } else {
            $(this).addClass(t);
			$(this).closest("li").addClass(t);
			$(this).attr("data-type","1");
			addPanelLayout($(this));
        }
		handleSavePanelPosition();
		handleThemePanelData();
    });
}
var addPanelLayout=function($this){
	var a=100, obj;
	var data={
			id:$this.attr("data-id"),
			title:$this.attr("data-title"),
			url:$this.attr("data-url"),
			modelColor:$this.attr("data-color")
		};
	$(".ui-sortable").each(function(){
		if($(this).children(":not('.hide')").length<a){
			a=$(this).children(":not('.hide')").length;
			obj=$(this);
		}
	});
	obj.panelCreatLayout(data);
	handlePanelAction();
};
var addPanelColorLayout=function(){
	$("#pcolor").colorpicker({
        fillcolor:true,
        event:'click',
        point:"right",
        inputshow:true,
        target:$("#pcolor"),
        success:function(o,color){
        	top.mainFrame.document.getElementById("pcolor").value = color;
        }
    });
}
var handleThemePanelData = function(e) {
	var t=[];
	$('[data-click="menulist"]').each(function(index,item_obj){
		var m={};
		m["title"]=$(item_obj).attr("data-title");
		m["url"]=$(item_obj).attr("data-url");
		m["type"]=$(item_obj).attr("data-type");
		m["id"]=$(item_obj).attr("data-id");
		t.push(m);
	});
	localStorage.setItem("menuData", JSON.stringify(t));
}

var handleSavePanelPosition = function(e) {           //存取数据位置，并且存入数据库
    
    if ($(".ui-sortable").length !== 0) {
        var t = [];
        var n = 0;
        $.when($(".ui-sortable").each(function() {
            var e = $(this).find("[data-sortable-id]:not('.hide')");
			var c="";
            if (e.length !== 0) {
                var r = [];
                $(e).each(function() {
                    var e = $(this).attr("data-sortable-id");
                    if($(this).attr("data-color")&&$(this).attr("data-color").length>0){
                    	c=$(this).attr("data-color");
                    }
                    else{
                    	c=$(this).find(".panel-heading").attr("class");
    					c=c.toString().replace(/panel-heading/g,"").replace("-","").replace(/[ ]/g,"");
                    }
                    r.push({
                        id: e,
						bgColor:c,
						title:$(this).find(".panel-title").text(),
						url:""
                    })
                });
                t.push(r)
            } else {
                t.push([])
            }
            n++;
        })).done(function() {
            var n = window.location.href;
            n = n.split("?");
            n = n[0];
            n=n+"_"+sessionid;
            localStorage.setItem(n, JSON.stringify(t));
            if(savePanelPosition){
            	savePanelPosition(t);
            }//存入数据库
            $(e).find('[data-id="title-spinner"]').delay(500).fadeOut(500,
            function() {
                $(this).remove()
            })
        })
    }
};
var handleLocalStorage = function() { //存在本地
    
    if (typeof Storage !== "undefined") {
        var e = window.location.href;
        e = e.split("?");
        e = e[0];
        var t = localStorage.getItem(e);
        if (t) {
            t = JSON.parse(t);
            var n = 0;
            $(".panel").parent('[class*="col-"]').each(function() {
                var e = t[n];
                var r = $(this);
                $.each(e,
                function(e, t) {
                    var n = '[data-sortable-id="' + t.id + '"]';
                    if ($(n).length !== 0) {
                        var i = $(n).clone();
						if(t.bgColor.length>0){
							i.children(".panel-heading").removeClass().addClass("panel-heading panel-heading-"+t.bgColor);
							$(".theme-panel").find(".theme-list>li.active").removeClass();
							$(".theme-panel").find("a[data-theme="+t.bgColor+"]").closest("li").addClass("active");
						}
                        $(n).remove();
                        $(r).append(i)
                    }
                });
                n++
            })
        }
    } else {
        alert("Your browser is not supported with the local storage")
    }
};
var handleResetLocalStorage = function() { //清除本地数据
    
 /*   $("[data-click=reset-local-storage]").live("click",
    function(e) {
        e.preventDefault();
        var t = "" + '<div class="modal fade" data-modal-id="reset-local-storage-confirmation">' + '    <div class="modal-dialog">' + '        <div class="modal-content">' + '            <div class="modal-header">' + '                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>' + '                <h4 class="modal-title"><i class="fa fa-refresh m-r-5"></i> Reset Local Storage Confirmation</h4>' + "            </div>" + '            <div class="modal-body">' + '                <div class="alert alert-info m-b-0">Would you like to RESET all your saved widgets and clear Local Storage?</div>' + "            </div>" + '            <div class="modal-footer">' + '                <a href="javascript:;" class="btn btn-sm btn-white" data-dismiss="modal"><i class="fa fa-close"></i> No</a>' + '                <a href="javascript:;" class="btn btn-sm btn-inverse" data-click="confirm-reset-local-storage"><i class="fa fa-check"></i> Yes</a>' + "            </div>" + "        </div>" + "    </div>" + "</div>";
        $("body").append(t);
        $('[data-modal-id="reset-local-storage-confirmation"]').modal("show")
    });
    $('[data-modal-id="reset-local-storage-confirmation"]').live("hidden.bs.modal",
    function() {
        $('[data-modal-id="reset-local-storage-confirmation"]').remove()
    });
    $("[data-click=confirm-reset-local-storage]").live("click",
    function(e) {
        e.preventDefault();*/
      /*  var t = window.location.href;
        t = t.split("?");
        t = t[0];
        localStorage.removeItem(t);
		localStorage.removeItem("menuData");
        window.location.href = document.URL*/
   // })
};
var handleIEFullHeightContent = function() {
    var e = window.navigator.userAgent;
    var t = e.indexOf("MSIE ");
    if (t > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./)) {
        $('.vertical-box-row [data-scrollbar="true"][data-height="100%"]').each(function() {
            var e = $(this).closest(".vertical-box-row");
            var t = $(e).height();
            $(e).find(".vertical-box-cell").height(t)
        })
    }
};
var handleUnlimitedTabsRender = function() {
    function e(e, t) {
        var n = parseInt($(e).css("margin-left"));
        var r = $(e).width();
        var i = $(e).find("li.active").width();
        var s = t > -1 ? t: 150;
        var o = 0;
        $(e).find("li.active").prevAll().each(function() {
            i += $(this).width()
        });
        $(e).find("li").each(function() {
            o += $(this).width()
        });
        if (i >= r) {
            var u = i - r;
            if (o != i) {
                u += 40
            }
            $(e).find(".nav.nav-tabs").animate({
                marginLeft: "-" + u + "px"
            },
            s)
        }
        if (i != o && o >= r) {
            $(e).addClass("overflow-right")
        } else {
            $(e).removeClass("overflow-right")
        }
        if (i >= r && o >= r) {
            $(e).addClass("overflow-left")
        } else {
            $(e).removeClass("overflow-left")
        }
    }
    function t(e, t) {
        var n = $(e).closest(".tab-overflow");
        var r = parseInt($(n).find(".nav.nav-tabs").css("margin-left"));
        var i = $(n).width();
        var s = 0;
        var o = 0;
        $(n).find("li").each(function() {
            if (!$(this).hasClass("next-button") && !$(this).hasClass("prev-button")) {
                s += $(this).width()
            }
        });
        switch (t) {
        case "next":
            var u = s + r - i;
            if (u <= i) {
                o = u - r;
                setTimeout(function() {
                    $(n).removeClass("overflow-right")
                },
                150)
            } else {
                o = i - r - 80
            }
            if (o != 0) {
                $(n).find(".nav.nav-tabs").animate({
                    marginLeft: "-" + o + "px"
                },
                150,
                function() {
                    $(n).addClass("overflow-left")
                })
            }
            break;
        case "prev":
            var u = -r;
            if (u <= i) {
                $(n).removeClass("overflow-left");
                o = 0
            } else {
                o = u - i + 80
            }
            $(n).find(".nav.nav-tabs").animate({
                marginLeft: "-" + o + "px"
            },
            150,
            function() {
                $(n).addClass("overflow-right")
            });
            break
        }
    }
    function n() {
        $(".tab-overflow").each(function() {
            var t = $(this).width();
            var n = 0;
            var r = $(this);
            var i = t;
            $(r).find("li").each(function() {
                var e = $(this);
                n += $(e).width();
                if ($(e).hasClass("active") && n > t) {
                    i -= n
                }
            });
            e(this, 0)
        })
    }
    $('[data-click="next-tab"]').live("click",
    function(e) {
        e.preventDefault();
        t(this, "next")
    });
    $('[data-click="prev-tab"]').live("click",
    function(e) {
        e.preventDefault();
        t(this, "prev")
    });
    $(window).resize(function() {
        $(".tab-overflow .nav.nav-tabs").removeAttr("style");
        n()
    });
    n()
};
var App = function() {
    return {
        init: function() {
            handleDraggablePanel();
         //	handleLocalStorage();
         //   handleResetLocalStorage();
            handleSlimScroll();
        //    handleSidebarMenu();
         //   handleMobileSidebarToggle();
        //    handleSidebarMinify();
            handleThemePageStructureControl();
            handleThemePanelExpand();
        //    handleAfterPageLoadAddClass();
            handlePanelAction();
			handleThemePanelDataFn();
        //    handelTooltipPopoverActivation();
        //    handleScrollToTopButton();
         //   handlePageContentView();
           handleIEFullHeightContent();
        //    handleUnlimitedTabsRender()
        }
    }
} ()